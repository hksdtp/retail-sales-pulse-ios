<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Password Fix</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #2a2a2a; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        button { padding: 10px 15px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; }
        button:hover { background: #444; }
        input { padding: 8px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; width: 200px; }
        pre { background: #1a1a1a; padding: 10px; border-left: 3px solid #00ff00; overflow-x: auto; max-height: 300px; overflow-y: auto; }
        .test-case { border: 1px solid #555; margin: 10px 0; padding: 10px; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Password Fix</h1>
    <p>Kiá»ƒm tra xem fix Ä‘Ã£ hoáº¡t Ä‘á»™ng chÆ°a</p>
    
    <div class="section">
        <h2>ðŸ”§ Setup Test User</h2>
        <input type="text" id="setup-userId" placeholder="User ID" value="test_user_123">
        <input type="email" id="setup-email" placeholder="Email" value="test@example.com">
        <input type="text" id="setup-name" placeholder="Name" value="Test User">
        <select id="setup-role">
            <option value="employee">Employee</option>
            <option value="team_leader">Team Leader</option>
            <option value="retail_director">Retail Director</option>
        </select>
        <button onclick="setupTestUser()">Setup Test User</button>
        <pre id="setup-output"></pre>
    </div>

    <div class="section">
        <h2>ðŸ§ª Test Scenarios</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearTestData()">Clear Test Data</button>
        <pre id="test-output"></pre>
    </div>

    <div class="section">
        <h2>ðŸ“Š Current State</h2>
        <button onclick="showCurrentState()">Show Current State</button>
        <pre id="state-output"></pre>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            element.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function setupTestUser() {
            clearLog('setup-output');
            
            const userId = document.getElementById('setup-userId').value;
            const email = document.getElementById('setup-email').value;
            const name = document.getElementById('setup-name').value;
            const role = document.getElementById('setup-role').value;
            
            const testUser = {
                id: userId,
                name: name,
                email: email,
                role: role,
                team_id: '1',
                location: 'HÃ  Ná»™i',
                department: 'Test',
                department_type: 'retail',
                position: 'Test Position',
                status: 'active',
                password_changed: false
            };
            
            // Save to localStorage
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            
            // Add to mockUsers if exists
            try {
                let mockUsers = [];
                const existingMockUsers = localStorage.getItem('mockUsers');
                if (existingMockUsers) {
                    mockUsers = JSON.parse(existingMockUsers);
                }
                
                // Remove existing test user
                mockUsers = mockUsers.filter(u => u.id !== userId);
                // Add new test user
                mockUsers.push(testUser);
                
                localStorage.setItem('mockUsers', JSON.stringify(mockUsers));
                
                log('setup-output', `âœ… Test user created: ${name} (${email})`, 'success');
                log('setup-output', `   Role: ${role}`, 'info');
                log('setup-output', `   Password changed: ${testUser.password_changed}`, 'info');
                
            } catch (error) {
                log('setup-output', `Error setting up test user: ${error.message}`, 'error');
            }
        }

        async function simulatePasswordChange(userId, newPassword) {
            // Simulate mockChangePassword function
            localStorage.setItem(`user_password_${userId}`, newPassword);
            
            // Update currentUser
            const currentUserStr = localStorage.getItem('currentUser');
            if (currentUserStr) {
                const currentUser = JSON.parse(currentUserStr);
                if (currentUser.id === userId) {
                    currentUser.password_changed = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            }
            
            // Update mockUsers
            const mockUsersStr = localStorage.getItem('mockUsers');
            if (mockUsersStr) {
                const mockUsers = JSON.parse(mockUsersStr);
                const userIndex = mockUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    mockUsers[userIndex].password_changed = true;
                    localStorage.setItem('mockUsers', JSON.stringify(mockUsers));
                }
            }
            
            return true;
        }

        function simulateLogin(email, password, user) {
            // Simulate the fixed mockLogin logic
            const ADMIN_PASSWORD = 'Haininh1';
            const DEFAULT_PASSWORD = '123456';
            
            const isAdminLogin = password === ADMIN_PASSWORD;
            const isDefaultPassword = password === DEFAULT_PASSWORD;
            
            if (isAdminLogin) {
                return { success: true, reason: 'admin_access' };
            }
            
            if (user.role === 'retail_director' && isDefaultPassword && !user.password_changed) {
                return { success: true, reason: 'director_first_login' };
            }
            
            const storedPassword = localStorage.getItem(`user_password_${user.id}`);
            
            if (storedPassword) {
                if (password === storedPassword) {
                    return { success: true, reason: 'custom_password_match' };
                } else {
                    return { success: false, reason: 'custom_password_mismatch' };
                }
            } else if (isDefaultPassword && !user.password_changed) {
                return { success: true, reason: 'first_login_default' };
            } else {
                return { success: false, reason: 'no_valid_password' };
            }
        }

        async function runAllTests() {
            clearLog('test-output');
            
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                log('test-output', 'No test user found. Please setup a test user first.', 'error');
                return;
            }
            
            const user = JSON.parse(currentUserStr);
            log('test-output', `ðŸ§ª Running tests for: ${user.name} (${user.role})`, 'info');
            
            // Test 1: First login with default password
            log('test-output', '\nðŸ“ Test 1: First login with default password', 'info');
            const test1 = simulateLogin(user.email, '123456', user);
            log('test-output', `   Result: ${test1.success ? 'PASS' : 'FAIL'} (${test1.reason})`, test1.success ? 'success' : 'error');
            
            // Test 2: Login with wrong password
            log('test-output', '\nðŸ“ Test 2: Login with wrong password', 'info');
            const test2 = simulateLogin(user.email, 'wrongpassword', user);
            log('test-output', `   Result: ${!test2.success ? 'PASS' : 'FAIL'} (${test2.reason})`, !test2.success ? 'success' : 'error');
            
            // Test 3: Change password
            log('test-output', '\nðŸ“ Test 3: Change password to "newpassword123"', 'info');
            await simulatePasswordChange(user.id, 'newpassword123');
            const updatedUser = JSON.parse(localStorage.getItem('currentUser'));
            log('test-output', `   Password changed flag: ${updatedUser.password_changed}`, updatedUser.password_changed ? 'success' : 'error');
            
            // Test 4: Login with old default password after change (SHOULD FAIL)
            log('test-output', '\nðŸ“ Test 4: Login with old default password after change (SHOULD FAIL)', 'info');
            const test4 = simulateLogin(user.email, '123456', updatedUser);
            log('test-output', `   Result: ${!test4.success ? 'PASS' : 'FAIL'} (${test4.reason})`, !test4.success ? 'success' : 'error');
            
            // Test 5: Login with new password (SHOULD PASS)
            log('test-output', '\nðŸ“ Test 5: Login with new password (SHOULD PASS)', 'info');
            const test5 = simulateLogin(user.email, 'newpassword123', updatedUser);
            log('test-output', `   Result: ${test5.success ? 'PASS' : 'FAIL'} (${test5.reason})`, test5.success ? 'success' : 'error');
            
            // Test 6: Admin password still works
            log('test-output', '\nðŸ“ Test 6: Admin password still works', 'info');
            const test6 = simulateLogin(user.email, 'Haininh1', updatedUser);
            log('test-output', `   Result: ${test6.success ? 'PASS' : 'FAIL'} (${test6.reason})`, test6.success ? 'success' : 'error');
            
            // Summary
            const passedTests = [test1.success, !test2.success, updatedUser.password_changed, !test4.success, test5.success, test6.success];
            const totalPassed = passedTests.filter(Boolean).length;
            
            log('test-output', `\nðŸŽ¯ SUMMARY: ${totalPassed}/6 tests passed`, totalPassed === 6 ? 'success' : 'warning');
            
            if (totalPassed === 6) {
                log('test-output', 'ðŸŽ‰ ALL TESTS PASSED! The fix is working correctly.', 'success');
            } else {
                log('test-output', 'âš ï¸ Some tests failed. Check the logic above.', 'warning');
            }
        }

        function showCurrentState() {
            clearLog('state-output');
            
            // Show current user
            const currentUserStr = localStorage.getItem('currentUser');
            if (currentUserStr) {
                const user = JSON.parse(currentUserStr);
                log('state-output', 'ðŸ‘¤ Current User:', 'info');
                log('state-output', `   ID: ${user.id}`, 'info');
                log('state-output', `   Name: ${user.name}`, 'info');
                log('state-output', `   Email: ${user.email}`, 'info');
                log('state-output', `   Role: ${user.role}`, 'info');
                log('state-output', `   Password Changed: ${user.password_changed}`, 'info');
                
                // Show stored password
                const storedPassword = localStorage.getItem(`user_password_${user.id}`);
                log('state-output', `   Stored Password: ${storedPassword ? '***' + storedPassword.length + ' chars' : 'NOT SET'}`, 'info');
            } else {
                log('state-output', 'No current user found', 'warning');
            }
            
            // Show all password keys
            const passwordKeys = Object.keys(localStorage).filter(key => key.startsWith('user_password_'));
            log('state-output', `\nðŸ”‘ Password Keys (${passwordKeys.length}):`, 'info');
            passwordKeys.forEach(key => {
                const userId = key.replace('user_password_', '');
                const password = localStorage.getItem(key);
                log('state-output', `   ${userId}: ***${password.length} chars`, 'info');
            });
        }

        function clearTestData() {
            const userId = document.getElementById('setup-userId').value;
            
            // Remove test user data
            localStorage.removeItem('currentUser');
            localStorage.removeItem(`user_password_${userId}`);
            
            // Remove from mockUsers
            const mockUsersStr = localStorage.getItem('mockUsers');
            if (mockUsersStr) {
                const mockUsers = JSON.parse(mockUsersStr);
                const filteredUsers = mockUsers.filter(u => u.id !== userId);
                localStorage.setItem('mockUsers', JSON.stringify(filteredUsers));
            }
            
            clearLog('setup-output');
            clearLog('test-output');
            clearLog('state-output');
            
            alert('Test data cleared!');
        }
    </script>
</body>
</html>
