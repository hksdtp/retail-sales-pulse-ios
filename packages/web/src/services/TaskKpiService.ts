import { User } from '@/types/user';
import { Task } from '@/components/tasks/types/TaskTypes';
import { reportsDataService } from './ReportsDataService';

export interface TaskKpiData {
  title: string;
  value: string;
  oldValue: string;
  change: number;
  data: Array<{ value: number }>;
}

class TaskKpiService {
  private static instance: TaskKpiService;

  private constructor() {}

  public static getInstance(): TaskKpiService {
    if (!TaskKpiService.instance) {
      TaskKpiService.instance = new TaskKpiService();
    }
    return TaskKpiService.instance;
  }

  public getKpiDataForUser(currentUser: User | null, tasks: Task[] = []): TaskKpiData[] {
    if (!currentUser) return this.getDefaultKpiData();

    const isDirector = currentUser.role === 'retail_director';
    const isTeamLeader = currentUser.role === 'team_leader';

    if (isDirector) {
      return this.getDirectorKpiData(tasks);
    } else if (isTeamLeader) {
      return this.getTeamLeaderKpiData(currentUser, tasks);
    } else {
      return this.getEmployeeKpiData(currentUser, tasks);
    }
  }

  private getDirectorKpiData(tasks: Task[]): TaskKpiData[] {
    // T·ªïng KPI to√†n ph√≤ng - t·∫•t c·∫£ tasks ho√†n th√†nh
    const completedTasks = tasks.filter(task => task.status === 'completed');

    // T·ªïng c√°c lo·∫°i c√¥ng vi·ªác m·ªõi
    const totalKtsNew = completedTasks.filter(task => task.type === 'kts_new').length;
    const totalKhCdtNew = completedTasks.filter(task => task.type === 'kh_cdt_new').length;
    const totalSbgNew = completedTasks.filter(task => task.type === 'sbg_new').length;

    // T·ªïng c√°c lo·∫°i c√¥ng vi·ªác c≈©
    const totalKtsOld = completedTasks.filter(task => task.type === 'kts_old').length;
    const totalKhCdtOld = completedTasks.filter(task => task.type === 'kh_cdt_old').length;
    const totalSbgOld = completedTasks.filter(task => task.type === 'sbg_old').length;

    // L·∫•y t·ªïng doanh s·ªë to√†n ph√≤ng
    const salesMetrics = reportsDataService.getDashboardMetrics();

    return [
      {
        title: 'T·ªïng KTS',
        value: (totalKtsNew + totalKtsOld).toString(),
        oldValue: Math.round((totalKtsNew + totalKtsOld) * 0.8).toString(),
        change: (totalKtsNew + totalKtsOld) > 0 ? 15.2 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalKtsNew + totalKtsOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng KH/CƒêT',
        value: (totalKhCdtNew + totalKhCdtOld).toString(),
        oldValue: Math.round((totalKhCdtNew + totalKhCdtOld) * 0.8).toString(),
        change: (totalKhCdtNew + totalKhCdtOld) > 0 ? 12.3 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalKhCdtNew + totalKhCdtOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng SBG',
        value: (totalSbgNew + totalSbgOld).toString(),
        oldValue: Math.round((totalSbgNew + totalSbgOld) * 0.8).toString(),
        change: (totalSbgNew + totalSbgOld) > 0 ? 18.7 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalSbgNew + totalSbgOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng doanh s·ªë',
        value: `${Math.round(salesMetrics.totalSales / 1000000000 * 1000) / 1000}B`,
        oldValue: `${Math.round(salesMetrics.totalSales * 0.8 / 1000000000 * 1000) / 1000}B`,
        change: 15.8,
        data: Array(10).fill(0).map(() => ({ value: salesMetrics.totalSales / 1000000 * (0.8 + Math.random() * 0.4) }))
      }
    ];
  }

  private getTeamLeaderKpiData(currentUser: User, tasks: Task[]): TaskKpiData[] {
    // T·ªïng KPI nh√≥m - l·ªçc tasks c·ªßa nh√≥m (c√πng location)
    const teamTasks = tasks.filter(task => task.location === currentUser.location);
    const completedTasks = teamTasks.filter(task => task.status === 'completed');

    // T·ªïng c√°c lo·∫°i c√¥ng vi·ªác m·ªõi c·ªßa nh√≥m
    const totalKtsNew = completedTasks.filter(task => task.type === 'kts_new').length;
    const totalKhCdtNew = completedTasks.filter(task => task.type === 'kh_cdt_new').length;
    const totalSbgNew = completedTasks.filter(task => task.type === 'sbg_new').length;

    // T·ªïng c√°c lo·∫°i c√¥ng vi·ªác c≈© c·ªßa nh√≥m
    const totalKtsOld = completedTasks.filter(task => task.type === 'kts_old').length;
    const totalKhCdtOld = completedTasks.filter(task => task.type === 'kh_cdt_old').length;
    const totalSbgOld = completedTasks.filter(task => task.type === 'sbg_old').length;

    // L·∫•y t·ªïng doanh s·ªë nh√≥m t·ª´ ReportsDataService
    const teamData = reportsDataService.getEmployeesByLocation(currentUser.location || 'H√† N·ªôi');
    const totalSales = teamData.reduce((sum, emp) => sum + emp.sales, 0);

    return [
      {
        title: 'T·ªïng KTS nh√≥m',
        value: (totalKtsNew + totalKtsOld).toString(),
        oldValue: Math.round((totalKtsNew + totalKtsOld) * 0.8).toString(),
        change: (totalKtsNew + totalKtsOld) > 0 ? 12.1 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalKtsNew + totalKtsOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng KH/CƒêT nh√≥m',
        value: (totalKhCdtNew + totalKhCdtOld).toString(),
        oldValue: Math.round((totalKhCdtNew + totalKhCdtOld) * 0.8).toString(),
        change: (totalKhCdtNew + totalKhCdtOld) > 0 ? 9.8 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalKhCdtNew + totalKhCdtOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng SBG nh√≥m',
        value: (totalSbgNew + totalSbgOld).toString(),
        oldValue: Math.round((totalSbgNew + totalSbgOld) * 0.8).toString(),
        change: (totalSbgNew + totalSbgOld) > 0 ? 14.5 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalSbgNew + totalSbgOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng doanh s·ªë nh√≥m',
        value: `${Math.round(totalSales / 1000000000 * 1000) / 1000}B`,
        oldValue: `${Math.round(totalSales * 0.8 / 1000000000 * 1000) / 1000}B`,
        change: 14.2,
        data: Array(10).fill(0).map(() => ({ value: totalSales / 1000000 * (0.8 + Math.random() * 0.4) }))
      }
    ];
  }

  private getEmployeeKpiData(currentUser: User, tasks: Task[]): TaskKpiData[] {
    // KPI c√° nh√¢n - l·ªçc tasks c·ªßa b·∫£n th√¢n (assignedTo ho·∫∑c user_id)
    const userTasks = tasks.filter(task =>
      task.user_id === currentUser.id || task.assignedTo === currentUser.id
    );
    const completedTasks = userTasks.filter(task => task.status === 'completed');

    console.log(`üë§ Employee KPI for ${currentUser.name}:`, {
      totalTasks: userTasks.length,
      completedTasks: completedTasks.length,
      userId: currentUser.id
    });

    // T·ªïng c√°c lo·∫°i c√¥ng vi·ªác c√° nh√¢n - s·ª≠ d·ª•ng ƒë√∫ng type names
    const totalKtsNew = completedTasks.filter(task => task.type === 'architect_new').length;
    const totalKhCdtNew = completedTasks.filter(task => task.type === 'client_new').length;
    const totalSbgNew = completedTasks.filter(task => task.type === 'partner_new').length;

    const totalKtsOld = completedTasks.filter(task => task.type === 'architect_old').length;
    const totalKhCdtOld = completedTasks.filter(task => task.type === 'client_old').length;
    const totalSbgOld = completedTasks.filter(task => task.type === 'partner_old').length;

    // L·∫•y d·ªØ li·ªáu doanh s·ªë c√° nh√¢n t·ª´ ReportsDataService
    const employee = reportsDataService.getEmployeeById(currentUser.id);
    const salesData = employee ? employee.sales : 0;
    const salesInMillions = Math.round(salesData / 1000000);

    return [
      {
        title: 'T·ªïng KTS',
        value: (totalKtsNew + totalKtsOld).toString(),
        oldValue: Math.round((totalKtsNew + totalKtsOld) * 0.8).toString(),
        change: (totalKtsNew + totalKtsOld) > 0 ? 10.2 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalKtsNew + totalKtsOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng KH/CƒêT',
        value: (totalKhCdtNew + totalKhCdtOld).toString(),
        oldValue: Math.round((totalKhCdtNew + totalKhCdtOld) * 0.8).toString(),
        change: (totalKhCdtNew + totalKhCdtOld) > 0 ? 8.1 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalKhCdtNew + totalKhCdtOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'T·ªïng SBG',
        value: (totalSbgNew + totalSbgOld).toString(),
        oldValue: Math.round((totalSbgNew + totalSbgOld) * 0.8).toString(),
        change: (totalSbgNew + totalSbgOld) > 0 ? 11.4 : 0,
        data: Array(10).fill(0).map(() => ({ value: (totalSbgNew + totalSbgOld) * (0.8 + Math.random() * 0.4) }))
      },
      {
        title: 'Doanh s·ªë c√° nh√¢n',
        value: `${salesInMillions}tr`,
        oldValue: `${employee ? Math.round(employee.plan / 1000000) : 0}tr`,
        change: employee ? employee.rate - 100 : 0,
        data: Array(10).fill(0).map(() => ({ value: salesInMillions * (0.8 + Math.random() * 0.4) }))
      }
    ];
  }

  private getDefaultKpiData(): TaskKpiData[] {
    return [
      {
        title: 'T·ªïng KTS',
        value: '0',
        oldValue: '0',
        change: 0,
        data: Array(10).fill(0).map(() => ({ value: 0 }))
      },
      {
        title: 'T·ªïng KH/CƒêT',
        value: '0',
        oldValue: '0',
        change: 0,
        data: Array(10).fill(0).map(() => ({ value: 0 }))
      },
      {
        title: 'T·ªïng SBG',
        value: '0',
        oldValue: '0',
        change: 0,
        data: Array(10).fill(0).map(() => ({ value: 0 }))
      },
      {
        title: 'Doanh s·ªë',
        value: '0tr',
        oldValue: '0tr',
        change: 0,
        data: Array(10).fill(0).map(() => ({ value: 0 }))
      }
    ];
  }

  public getTaskStats(tasks: Task[], userId?: string, location?: string, role?: string) {
    let filteredTasks = tasks;

    // √Åp d·ª•ng filter theo ph√¢n quy·ªÅn
    if (role === 'employee' && userId) {
      filteredTasks = tasks.filter(task => task.user_id === userId);
    } else if (role === 'team_leader' && location) {
      filteredTasks = tasks.filter(task => task.location === location);
    }
    // Director th·∫•y t·∫•t c·∫£

    const totalTasks = filteredTasks.length;
    const completedTasks = filteredTasks.filter(task => task.status === 'completed').length;
    const inProgressTasks = filteredTasks.filter(task => task.status === 'in_progress').length;
    const todoTasks = filteredTasks.filter(task => task.status === 'todo').length;

    return {
      total: totalTasks,
      completed: completedTasks,
      inProgress: inProgressTasks,
      todo: todoTasks,
      completionRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
    };
  }
}

export const taskKpiService = TaskKpiService.getInstance();
