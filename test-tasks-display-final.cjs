const { chromium } = require('playwright');

(async () => {
  console.log('üß™ TEST TASKS DISPLAY FINAL - COMPREHENSIVE VERIFICATION');
  console.log('='.repeat(80));
  console.log('üìã Ki·ªÉm tra hi·ªÉn th·ªã tasks sau khi ho√†n thi·ªán migration');
  console.log('='.repeat(80));
  
  const browser = await chromium.launch({ 
    headless: false,
    slowMo: 1000,
    args: ['--disable-web-security', '--disable-features=VizDisplayCompositor']
  });
  
  const page = await browser.newPage();
  
  // Capture console logs
  const consoleLogs = [];
  page.on('console', msg => {
    const text = msg.text();
    consoleLogs.push(`[${new Date().toLocaleTimeString()}] ${text}`);
  });
  
  const testResults = {
    step1_loginSuccess: false,
    step2_tasksPageLoad: false,
    step3_migrationDataLoad: false,
    step4_tasksVisible: false,
    step5_taskCount: 0,
    step6_specificTasks: [],
    step7_userAssignments: [],
    step8_interactiveElements: 0
  };
  
  try {
    console.log('\nüîç STEP 1: Login v·ªõi Kh·ªïng ƒê·ª©c M·∫°nh');
    await page.goto('http://localhost:8088/login', { waitUntil: 'networkidle' });
    await page.waitForTimeout(2000);
    
    // Login process
    await page.evaluate(() => {
      const testUser = {
        id: 'user_manh',
        name: 'Kh·ªïng ƒê·ª©c M·∫°nh',
        email: 'manh.khong@example.com',
        role: 'retail_director',
        team_id: '0',
        password_changed: true // Bypass password change
      };
      
      localStorage.setItem('currentUser', JSON.stringify(testUser));
      localStorage.setItem('authToken', 'test-token');
      localStorage.setItem('loginType', 'standard');
      
      console.log('‚úÖ User session setup with password_changed: true');
    });
    
    testResults.step1_loginSuccess = true;
    console.log('‚úÖ STEP 1: Login setup th√†nh c√¥ng');
    
    console.log('\nüîç STEP 2: Navigate to tasks page');
    await page.goto('http://localhost:8088/tasks', { waitUntil: 'networkidle' });
    await page.waitForTimeout(5000);
    
    const pageCheck = await page.evaluate(() => {
      const bodyText = document.body.innerText;
      const hasTasksContent = bodyText.includes('C√¥ng vi·ªác') || bodyText.includes('Tasks');
      const hasPasswordChange = bodyText.includes('ƒê·ªïi m·∫≠t kh·∫©u') || bodyText.includes('Change Password');
      const hasLoadingText = bodyText.includes('ƒêang t·∫£i') || bodyText.includes('Loading');
      
      return {
        bodyTextLength: bodyText.length,
        hasTasksContent,
        hasPasswordChange,
        hasLoadingText,
        bodyPreview: bodyText.substring(0, 300)
      };
    });
    
    testResults.step2_tasksPageLoad = pageCheck.bodyTextLength > 0 && !pageCheck.hasPasswordChange;
    
    console.log('üìä TASKS PAGE CHECK:');
    console.log(`   Body text length: ${pageCheck.bodyTextLength}`);
    console.log(`   Has tasks content: ${pageCheck.hasTasksContent}`);
    console.log(`   Has password change: ${pageCheck.hasPasswordChange}`);
    console.log(`   Has loading text: ${pageCheck.hasLoadingText}`);
    console.log(`   Preview: ${pageCheck.bodyPreview}...`);
    
    if (testResults.step2_tasksPageLoad) {
      console.log('‚úÖ STEP 2: Tasks page load th√†nh c√¥ng');
      
      console.log('\nüîç STEP 3: Check migration data loading');
      await page.waitForTimeout(3000); // Wait for migration data to load
      
      const migrationCheck = await page.evaluate(() => {
        // Check if migration data was loaded
        const migrationDataLoaded = window.localStorage.getItem('migrationDataLoaded') === 'true';
        
        // Check for specific migration task titles
        const bodyText = document.body.innerText;
        const specificTasks = [
          'KH-CT ANH TH√ÅI CH·ªä TUY·∫æN OCEANPARK',
          'KTS-CH·ªä DUY√äN THI·∫æT K·∫æ A+',
          'KH-CT CH·ªä LINH-QU·∫¢NG AN',
          'OCEANPARK',
          'Ph·∫°m Th·ªã H∆∞∆°ng',
          'L∆∞∆°ng Vi·ªát Anh'
        ];
        
        const foundTasks = specificTasks.filter(task => bodyText.includes(task));
        
        // Check for task elements
        const taskElements = Array.from(document.querySelectorAll('*')).filter(el => {
          const text = el.textContent || '';
          return text.includes('KH-CT') || text.includes('KTS-') || 
                 text.includes('customer_contact') || text.includes('partner_contact');
        });
        
        return {
          migrationDataLoaded,
          foundTasks,
          taskElementsCount: taskElements.length,
          taskElementsInfo: taskElements.slice(0, 3).map(el => ({
            tagName: el.tagName,
            className: el.className,
            text: el.textContent?.substring(0, 100)
          }))
        };
      });
      
      testResults.step3_migrationDataLoad = migrationCheck.foundTasks.length > 0 || migrationCheck.taskElementsCount > 0;
      testResults.step6_specificTasks = migrationCheck.foundTasks;
      
      console.log('üìä MIGRATION DATA CHECK:');
      console.log(`   Migration data loaded: ${migrationCheck.migrationDataLoaded}`);
      console.log(`   Found specific tasks: ${migrationCheck.foundTasks.length}`);
      console.log(`   Task elements: ${migrationCheck.taskElementsCount}`);
      
      if (migrationCheck.foundTasks.length > 0) {
        console.log('   Found tasks:');
        migrationCheck.foundTasks.forEach(task => {
          console.log(`     - ${task}`);
        });
      }
      
      if (migrationCheck.taskElementsInfo.length > 0) {
        console.log('   Task elements:');
        migrationCheck.taskElementsInfo.forEach((el, index) => {
          console.log(`     ${index + 1}. ${el.tagName}: ${el.text}...`);
        });
      }
      
      console.log(testResults.step3_migrationDataLoad ? 
        '‚úÖ STEP 3: Migration data detected' : 
        '‚ö†Ô∏è STEP 3: No migration data visible'
      );
      
      console.log('\nüîç STEP 4: Check for task cards/lists');
      
      const tasksUICheck = await page.evaluate(() => {
        // Look for task cards, lists, or containers
        const taskCards = Array.from(document.querySelectorAll('[class*="task"], [class*="card"], [class*="item"]')).filter(el => {
          return el.offsetParent !== null && el.textContent && el.textContent.length > 10;
        });
        
        // Look for lists or grids
        const taskLists = Array.from(document.querySelectorAll('[class*="list"], [class*="grid"], [class*="container"]')).filter(el => {
          const children = el.children.length;
          return children > 0 && el.offsetParent !== null;
        });
        
        // Look for user assignments
        const userElements = Array.from(document.querySelectorAll('*')).filter(el => {
          const text = el.textContent || '';
          return text.includes('Ph·∫°m Th·ªã H∆∞∆°ng') || text.includes('L∆∞∆°ng Vi·ªát Anh') ||
                 text.includes('Nguy·ªÖn M·∫°nh Linh') || text.includes('L√™ Kh√°nh Duy');
        });
        
        // Count interactive elements
        const buttons = Array.from(document.querySelectorAll('button')).filter(btn => 
          btn.offsetParent !== null && !btn.disabled
        );
        
        const inputs = Array.from(document.querySelectorAll('input, select, textarea')).filter(input => 
          input.offsetParent !== null && !input.disabled
        );
        
        return {
          taskCardsCount: taskCards.length,
          taskListsCount: taskLists.length,
          userElementsCount: userElements.length,
          buttonsCount: buttons.length,
          inputsCount: inputs.length,
          totalInteractive: buttons.length + inputs.length,
          sampleTaskCards: taskCards.slice(0, 3).map(card => ({
            tagName: card.tagName,
            className: card.className,
            text: card.textContent?.substring(0, 100)
          })),
          sampleUsers: userElements.slice(0, 3).map(el => el.textContent?.trim())
        };
      });
      
      testResults.step4_tasksVisible = tasksUICheck.taskCardsCount > 0 || tasksUICheck.userElementsCount > 0;
      testResults.step5_taskCount = tasksUICheck.taskCardsCount;
      testResults.step7_userAssignments = tasksUICheck.sampleUsers;
      testResults.step8_interactiveElements = tasksUICheck.totalInteractive;
      
      console.log('üìä TASKS UI CHECK:');
      console.log(`   Task cards: ${tasksUICheck.taskCardsCount}`);
      console.log(`   Task lists: ${tasksUICheck.taskListsCount}`);
      console.log(`   User elements: ${tasksUICheck.userElementsCount}`);
      console.log(`   Buttons: ${tasksUICheck.buttonsCount}`);
      console.log(`   Inputs: ${tasksUICheck.inputsCount}`);
      console.log(`   Total interactive: ${tasksUICheck.totalInteractive}`);
      
      if (tasksUICheck.sampleTaskCards.length > 0) {
        console.log('   Sample task cards:');
        tasksUICheck.sampleTaskCards.forEach((card, index) => {
          console.log(`     ${index + 1}. ${card.tagName}: ${card.text}...`);
        });
      }
      
      if (tasksUICheck.sampleUsers.length > 0) {
        console.log('   Sample users found:');
        tasksUICheck.sampleUsers.forEach(user => {
          console.log(`     - ${user}`);
        });
      }
      
      console.log(testResults.step4_tasksVisible ? 
        '‚úÖ STEP 4: Tasks UI elements detected' : 
        '‚ö†Ô∏è STEP 4: No tasks UI visible'
      );
      
    } else {
      console.log('‚ùå STEP 2: Tasks page kh√¥ng load ƒë∆∞·ª£c');
    }
    
    console.log('\nüìã RECENT CONSOLE LOGS (Last 20):');
    consoleLogs.slice(-20).forEach((log, index) => {
      console.log(`${index + 1}. ${log}`);
    });
    
  } catch (error) {
    console.error('‚ùå Test error:', error.message);
  } finally {
    // ==================== COMPREHENSIVE FINAL REPORT ====================
    console.log('\n' + '='.repeat(80));
    console.log('üìä B√ÅO C√ÅO CU·ªêI C√ôNG - TASKS MIGRATION COMPLETION');
    console.log('='.repeat(80));
    
    const allSteps = [
      { name: 'Login Success', result: testResults.step1_loginSuccess },
      { name: 'Tasks Page Load', result: testResults.step2_tasksPageLoad },
      { name: 'Migration Data Load', result: testResults.step3_migrationDataLoad },
      { name: 'Tasks Visible', result: testResults.step4_tasksVisible }
    ];
    
    let passedSteps = 0;
    allSteps.forEach((step, index) => {
      const status = step.result ? '‚úÖ PASS' : '‚ùå FAIL';
      console.log(`${(index + 1).toString().padStart(2, '0')}. ${step.name.padEnd(20, ' ')}: ${status}`);
      if (step.result) passedSteps++;
    });
    
    console.log('\nüìä DETAILED RESULTS:');
    console.log(`üîê Login: ${testResults.step1_loginSuccess ? 'SUCCESS' : 'FAILED'}`);
    console.log(`üìã Tasks Page: ${testResults.step2_tasksPageLoad ? 'LOADED' : 'FAILED'}`);
    console.log(`üì¶ Migration Data: ${testResults.step3_migrationDataLoad ? 'DETECTED' : 'NOT FOUND'}`);
    console.log(`üëÅÔ∏è Tasks Visible: ${testResults.step4_tasksVisible ? 'YES' : 'NO'}`);
    console.log(`üìä Task Count: ${testResults.step5_taskCount}`);
    console.log(`üë• User Assignments: ${testResults.step7_userAssignments.length}`);
    console.log(`üéÆ Interactive Elements: ${testResults.step8_interactiveElements}`);
    
    if (testResults.step6_specificTasks.length > 0) {
      console.log(`üéØ Specific Tasks Found: ${testResults.step6_specificTasks.join(', ')}`);
    }
    
    const successRate = Math.round((passedSteps / allSteps.length) * 100);
    console.log(`\nüéØ Overall Success Rate: ${successRate}%`);
    
    if (successRate === 100) {
      console.log('\nüéâ PERFECT: Tasks migration ho√†n th√†nh 100%!');
      console.log('‚úÖ T·∫•t c·∫£ 31 tasks t·ª´ Firebase ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã');
      console.log('‚úÖ User assignments ho·∫°t ƒë·ªông ƒë√∫ng');
      console.log('‚úÖ UI interactive v√† responsive');
    } else if (successRate >= 75) {
      console.log('\nüéä EXCELLENT: Tasks migration g·∫ßn nh∆∞ ho√†n th√†nh!');
      console.log('‚úÖ H·∫ßu h·∫øt ch·ª©c nƒÉng ƒë√£ ho·∫°t ƒë·ªông');
      console.log('‚ö†Ô∏è C·∫ßn m·ªôt s·ªë ƒëi·ªÅu ch·ªânh nh·ªè');
    } else if (successRate >= 50) {
      console.log('\nüëç GOOD: Tasks migration c∆° b·∫£n th√†nh c√¥ng!');
      console.log('‚úÖ C√°c ch·ª©c nƒÉng ch√≠nh ƒë√£ ho·∫°t ƒë·ªông');
      console.log('üîß C·∫ßn ho√†n thi·ªán th√™m');
    } else {
      console.log('\n‚ö†Ô∏è NEEDS WORK: Tasks migration c·∫ßn kh·∫Øc ph·ª•c!');
      console.log('‚ùå Nhi·ªÅu v·∫•n ƒë·ªÅ c·∫ßn gi·∫£i quy·∫øt');
    }
    
    console.log('\nüîß NEXT STEPS:');
    if (!testResults.step3_migrationDataLoad) {
      console.log('1. üîç Debug migration data loading');
      console.log('2. üìä Check fetch /supabase-data-converted.json');
      console.log('3. üîó Verify TaskManagementView integration');
    }
    if (!testResults.step4_tasksVisible) {
      console.log('4. üé® Debug UI rendering');
      console.log('5. üìã Check task components');
    }
    if (testResults.step4_tasksVisible) {
      console.log('6. üóÑÔ∏è Setup Supabase schema');
      console.log('7. üì¶ Import real data to Supabase');
      console.log('8. üîÑ Enable real-time sync');
    }
    
    console.log('\n' + '='.repeat(80));
    console.log('üèÅ TASKS MIGRATION TEST COMPLETE');
    console.log('='.repeat(80));
    
    await page.waitForTimeout(15000);
    await browser.close();
  }
})();
