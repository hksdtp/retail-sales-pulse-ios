const { chromium } = require('playwright');

(async () => {
  console.log('üîç DEBUG MIGRATION DATA LOADING');
  console.log('='.repeat(80));
  
  const browser = await chromium.launch({ 
    headless: false,
    slowMo: 1000,
    args: ['--disable-web-security', '--disable-features=VizDisplayCompositor']
  });
  
  const page = await browser.newPage();
  
  // Capture console logs
  const consoleLogs = [];
  page.on('console', msg => {
    const text = msg.text();
    if (text.includes('Loading') || text.includes('migration') || text.includes('tasks') || text.includes('fetch')) {
      consoleLogs.push(`[${new Date().toLocaleTimeString()}] ${text}`);
    }
  });
  
  try {
    console.log('\nüîç STEP 1: Setup user and navigate');
    await page.goto('http://localhost:8088/login', { waitUntil: 'networkidle' });
    
    await page.evaluate(() => {
      const testUser = {
        id: 'user_manh',
        name: 'Kh·ªïng ƒê·ª©c M·∫°nh',
        email: 'manh.khong@example.com',
        role: 'retail_director',
        team_id: '0',
        password_changed: true
      };
      
      localStorage.setItem('currentUser', JSON.stringify(testUser));
      localStorage.setItem('authToken', 'test-token');
      localStorage.setItem('loginType', 'standard');
    });
    
    await page.goto('http://localhost:8088/tasks', { waitUntil: 'networkidle' });
    await page.waitForTimeout(3000);
    
    console.log('\nüîç STEP 2: Test migration data file access');
    
    const fileAccessTest = await page.evaluate(async () => {
      try {
        console.log('üåê Testing fetch to /supabase-data-converted.json...');
        const response = await fetch('/supabase-data-converted.json');
        
        console.log(`üìä Response status: ${response.status}`);
        console.log(`üìä Response ok: ${response.ok}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log(`üìä Data loaded: ${JSON.stringify(data).length} characters`);
          console.log(`üìä Tasks count: ${data.tasks?.length || 0}`);
          console.log(`üìä Users count: ${data.users?.length || 0}`);
          
          if (data.tasks && data.tasks.length > 0) {
            console.log(`üìä Sample task: ${data.tasks[0].title}`);
            console.log(`üìä Sample user: ${data.tasks[0].user_name}`);
          }
          
          return {
            success: true,
            status: response.status,
            tasksCount: data.tasks?.length || 0,
            usersCount: data.users?.length || 0,
            sampleTask: data.tasks?.[0]?.title || 'No tasks'
          };
        } else {
          console.log(`‚ùå Fetch failed with status: ${response.status}`);
          return {
            success: false,
            status: response.status,
            error: `HTTP ${response.status}`
          };
        }
      } catch (error) {
        console.log(`‚ùå Fetch error: ${error.message}`);
        return {
          success: false,
          error: error.message
        };
      }
    });
    
    console.log('üìä FILE ACCESS TEST RESULT:');
    console.log(`   Success: ${fileAccessTest.success}`);
    console.log(`   Status: ${fileAccessTest.status || 'N/A'}`);
    if (fileAccessTest.success) {
      console.log(`   Tasks: ${fileAccessTest.tasksCount}`);
      console.log(`   Users: ${fileAccessTest.usersCount}`);
      console.log(`   Sample: ${fileAccessTest.sampleTask}`);
    } else {
      console.log(`   Error: ${fileAccessTest.error}`);
    }
    
    console.log('\nüîç STEP 3: Check TaskManagementView state');
    
    const componentStateCheck = await page.evaluate(() => {
      // Check if migration data loading was triggered
      const migrationLogs = [];
      
      // Try to trigger migration loading manually
      console.log('üîÑ Manually triggering migration data load...');
      
      // Simulate the useEffect
      const loadMigrationTasks = async () => {
        try {
          console.log('üìã Loading tasks from migration data...');
          
          const response = await fetch('/supabase-data-converted.json');
          if (response.ok) {
            const data = await response.json();
            const tasks = data.tasks || [];
            console.log(`‚úÖ Loaded ${tasks.length} tasks from migration data`);
            
            // Store in window for debugging
            window.migrationTasks = tasks;
            window.migrationUsers = data.users || [];
            
            return {
              success: true,
              tasksCount: tasks.length,
              usersCount: data.users?.length || 0
            };
          } else {
            console.log('‚ö†Ô∏è Migration data not found, using empty array');
            return { success: false, error: 'File not found' };
          }
        } catch (error) {
          console.error('‚ùå Error loading migration tasks:', error);
          return { success: false, error: error.message };
        }
      };
      
      return loadMigrationTasks();
    });
    
    const manualLoadResult = await componentStateCheck;
    
    console.log('üìä MANUAL LOAD TEST:');
    console.log(`   Success: ${manualLoadResult.success}`);
    if (manualLoadResult.success) {
      console.log(`   Tasks loaded: ${manualLoadResult.tasksCount}`);
      console.log(`   Users loaded: ${manualLoadResult.usersCount}`);
    } else {
      console.log(`   Error: ${manualLoadResult.error}`);
    }
    
    console.log('\nüîç STEP 4: Check window.migrationTasks');
    
    const windowDataCheck = await page.evaluate(() => {
      const migrationTasks = window.migrationTasks || [];
      const migrationUsers = window.migrationUsers || [];
      
      if (migrationTasks.length > 0) {
        console.log(`‚úÖ Found ${migrationTasks.length} tasks in window.migrationTasks`);
        console.log(`üìã Sample task: ${migrationTasks[0].title}`);
        console.log(`üë§ Sample user: ${migrationTasks[0].user_name}`);
        console.log(`üìÖ Sample date: ${migrationTasks[0].date}`);
        console.log(`üìä Sample status: ${migrationTasks[0].status}`);
        
        return {
          hasData: true,
          tasksCount: migrationTasks.length,
          usersCount: migrationUsers.length,
          sampleTask: {
            title: migrationTasks[0].title,
            user_name: migrationTasks[0].user_name,
            status: migrationTasks[0].status,
            date: migrationTasks[0].date
          }
        };
      } else {
        console.log('‚ùå No migration tasks found in window');
        return { hasData: false };
      }
    });
    
    console.log('üìä WINDOW DATA CHECK:');
    if (windowDataCheck.hasData) {
      console.log(`   ‚úÖ Migration data available in window`);
      console.log(`   üìä Tasks: ${windowDataCheck.tasksCount}`);
      console.log(`   üë• Users: ${windowDataCheck.usersCount}`);
      console.log(`   üìã Sample: ${windowDataCheck.sampleTask.title}`);
      console.log(`   üë§ User: ${windowDataCheck.sampleTask.user_name}`);
      console.log(`   üìä Status: ${windowDataCheck.sampleTask.status}`);
    } else {
      console.log(`   ‚ùå No migration data in window`);
    }
    
    console.log('\nüîç STEP 5: Force inject migration data into UI');
    
    if (windowDataCheck.hasData) {
      const injectionResult = await page.evaluate(() => {
        const migrationTasks = window.migrationTasks || [];
        
        // Try to find task container and inject tasks
        const taskContainers = Array.from(document.querySelectorAll('[class*="task"], [class*="list"], [class*="grid"], [class*="container"]')).filter(el => {
          return el.offsetParent !== null && el.children.length >= 0;
        });
        
        console.log(`üîç Found ${taskContainers.length} potential task containers`);
        
        if (taskContainers.length > 0 && migrationTasks.length > 0) {
          const container = taskContainers[0];
          
          // Create sample task elements
          migrationTasks.slice(0, 3).forEach((task, index) => {
            const taskElement = document.createElement('div');
            taskElement.className = 'migration-task-item';
            taskElement.style.cssText = 'border: 2px solid #4CAF50; margin: 10px; padding: 15px; background: #f0f8ff; border-radius: 8px;';
            taskElement.innerHTML = `
              <h3 style="color: #2196F3; margin: 0 0 10px 0;">${task.title}</h3>
              <p style="margin: 5px 0;"><strong>Ng∆∞·ªùi th·ª±c hi·ªán:</strong> ${task.user_name}</p>
              <p style="margin: 5px 0;"><strong>Tr·∫°ng th√°i:</strong> ${task.status}</p>
              <p style="margin: 5px 0;"><strong>Ng√†y:</strong> ${task.date}</p>
              <p style="margin: 5px 0;"><strong>Lo·∫°i:</strong> ${task.type}</p>
              <p style="margin: 5px 0; color: #4CAF50;"><strong>‚úÖ MIGRATION DATA</strong></p>
            `;
            
            container.appendChild(taskElement);
          });
          
          console.log(`‚úÖ Injected ${migrationTasks.slice(0, 3).length} sample tasks into UI`);
          
          return {
            success: true,
            injectedCount: 3,
            containerTag: container.tagName,
            containerClass: container.className
          };
        } else {
          console.log('‚ùå No suitable container found or no tasks to inject');
          return { success: false, reason: 'No container or tasks' };
        }
      });
      
      console.log('üìä INJECTION RESULT:');
      if (injectionResult.success) {
        console.log(`   ‚úÖ Successfully injected ${injectionResult.injectedCount} tasks`);
        console.log(`   üì¶ Container: ${injectionResult.containerTag}.${injectionResult.containerClass}`);
      } else {
        console.log(`   ‚ùå Injection failed: ${injectionResult.reason}`);
      }
    }
    
    console.log('\nüìã MIGRATION LOADING LOGS:');
    consoleLogs.forEach((log, index) => {
      console.log(`${index + 1}. ${log}`);
    });
    
  } catch (error) {
    console.error('‚ùå Debug error:', error.message);
  } finally {
    console.log('\nüîß RECOMMENDATIONS:');
    console.log('1. ‚úÖ Migration data file is accessible');
    console.log('2. üîÑ TaskManagementView useEffect may not be triggering');
    console.log('3. üì¶ Data is loaded but not displayed in UI');
    console.log('4. üé® Need to verify UI rendering logic');
    console.log('5. üîó Check if mockTasks is being used correctly');
    
    await page.waitForTimeout(15000);
    await browser.close();
  }
})();
