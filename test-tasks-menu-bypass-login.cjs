const { chromium } = require('playwright');

(async () => {
  console.log('üöÄ TEST MENU C√îNG VI·ªÜC - BYPASS LOGIN');
  console.log('='.repeat(80));
  console.log('üìã Test s·∫Ω bypass login v√† tr·ª±c ti·∫øp test menu C√¥ng vi·ªác');
  console.log('='.repeat(80));
  
  const browser = await chromium.launch({ 
    headless: false,
    slowMo: 1000,
    args: ['--disable-web-security', '--disable-features=VizDisplayCompositor']
  });
  
  const page = await browser.newPage();
  
  try {
    // ==================== B∆Ø·ªöC 1: BYPASS LOGIN ====================
    console.log('\nüìã B∆Ø·ªöC 1: BYPASS LOGIN - Thi·∫øt l·∫≠p session gi·∫£');
    console.log('-'.repeat(60));
    
    await page.goto('http://localhost:8088/login', { 
      waitUntil: 'networkidle',
      timeout: 30000 
    });
    
    // Set up fake session
    const sessionSetup = await page.evaluate(() => {
      // Set fake user data
      const fakeUser = {
        id: '1b',
        name: 'Kh·ªïng ƒê·ª©c M·∫°nh',
        email: 'manh.khong@example.com',
        role: 'retail_director',
        team_id: '1',
        location: 'H√† N·ªôi',
        department: 'B√°n l·∫ª',
        department_type: 'retail',
        position: 'Tr∆∞·ªüng ph√≤ng',
        status: 'active',
        password_changed: true
      };
      
      localStorage.setItem('currentUser', JSON.stringify(fakeUser));
      localStorage.setItem('authToken', 'fake-auth-token');
      localStorage.setItem('loginType', 'standard');
      
      return { success: true, user: fakeUser };
    });
    
    console.log('‚úÖ ƒê√£ thi·∫øt l·∫≠p session gi·∫£:', sessionSetup.user.name);
    
    // ==================== B∆Ø·ªöC 2: NAVIGATE TO TASKS ====================
    console.log('\nüìã B∆Ø·ªöC 2: NAVIGATE TO TASKS - ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn trang tasks');
    console.log('-'.repeat(60));
    
    await page.goto('http://localhost:8088/tasks', { 
      waitUntil: 'networkidle',
      timeout: 30000 
    });
    console.log('‚úÖ ƒê√£ ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn /tasks');
    
    // ==================== B∆Ø·ªöC 3: WAIT FOR LOADING ====================
    console.log('\nüìã B∆Ø·ªöC 3: WAIT FOR LOADING - Ch·ªù loading ho√†n th√†nh');
    console.log('-'.repeat(60));
    
    console.log('‚è≥ ƒêang ch·ªù trang load ho√†n th√†nh...');
    
    // Ch·ªù loading screen bi·∫øn m·∫•t (t·ªëi ƒëa 30 gi√¢y)
    try {
      await page.waitForSelector('.absolute.inset-0.backdrop-blur-sm', { 
        state: 'detached', 
        timeout: 30000 
      });
      console.log('‚úÖ Loading screen ƒë√£ bi·∫øn m·∫•t');
    } catch (error) {
      console.log('‚ö†Ô∏è Loading screen v·∫´n c√≤n, ti·∫øp t·ª•c test...');
    }
    
    // Ch·ªù th√™m ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë√£ load
    await page.waitForTimeout(5000);
    
    // ==================== B∆Ø·ªöC 4: ANALYZE PAGE CONTENT ====================
    console.log('\nüìã B∆Ø·ªöC 4: ANALYZE PAGE CONTENT - Ph√¢n t√≠ch n·ªôi dung trang');
    console.log('-'.repeat(60));
    
    const pageAnalysis = await page.evaluate(() => {
      // Get all elements info
      const allButtons = Array.from(document.querySelectorAll('button')).map(btn => ({
        text: btn.textContent?.trim(),
        className: btn.className,
        disabled: btn.disabled
      })).filter(btn => btn.text);
      
      const allInputs = Array.from(document.querySelectorAll('input')).map(input => ({
        type: input.type,
        placeholder: input.placeholder,
        className: input.className
      }));
      
      const allSelects = Array.from(document.querySelectorAll('select')).map(select => ({
        options: Array.from(select.options).map(opt => opt.text),
        className: select.className
      }));
      
      // Check for task-related elements
      const taskElements = Array.from(document.querySelectorAll('*')).filter(el => {
        const text = el.textContent?.toLowerCase() || '';
        const className = el.className?.toLowerCase() || '';
        return text.includes('task') || text.includes('c√¥ng vi·ªác') || 
               className.includes('task') || className.includes('work');
      }).map(el => ({
        tagName: el.tagName,
        text: el.textContent?.substring(0, 100),
        className: el.className
      }));
      
      // Get page structure
      const hasTable = !!document.querySelector('table');
      const hasGrid = !!document.querySelector('.grid, [style*="grid"]');
      const hasList = !!document.querySelector('ul, ol, .list');
      
      // Check for loading states
      const loadingElements = document.querySelectorAll('.loading, .spinner, [class*="loading"]').length;
      const loadingText = document.body.innerText.includes('ƒêang') || 
                         document.body.innerText.includes('Loading') ||
                         document.body.innerText.includes('kh·ªüi t·∫°o');
      
      return {
        url: window.location.href,
        title: document.title,
        bodyText: document.body.innerText.substring(0, 1000),
        allButtons: allButtons.slice(0, 10), // Limit to first 10
        allInputs,
        allSelects,
        taskElements: taskElements.slice(0, 5), // Limit to first 5
        hasTable,
        hasGrid,
        hasList,
        loadingElements,
        loadingText,
        totalElements: {
          buttons: allButtons.length,
          inputs: allInputs.length,
          selects: allSelects.length,
          taskElements: taskElements.length
        }
      };
    });
    
    console.log('üìä Page Analysis:');
    console.log(`   - URL: ${pageAnalysis.url}`);
    console.log(`   - Title: ${pageAnalysis.title}`);
    console.log(`   - Loading: ${pageAnalysis.loadingText ? 'YES' : 'NO'}`);
    console.log(`   - Elements: ${pageAnalysis.totalElements.buttons} buttons, ${pageAnalysis.totalElements.inputs} inputs, ${pageAnalysis.totalElements.selects} selects`);
    console.log(`   - Task elements: ${pageAnalysis.totalElements.taskElements}`);
    console.log(`   - Structure: Table=${pageAnalysis.hasTable}, Grid=${pageAnalysis.hasGrid}, List=${pageAnalysis.hasList}`);
    
    // ==================== B∆Ø·ªöC 5: TEST SPECIFIC FEATURES ====================
    console.log('\nüìã B∆Ø·ªöC 5: TEST SPECIFIC FEATURES - Test c√°c t√≠nh nƒÉng c·ª• th·ªÉ');
    console.log('-'.repeat(60));
    
    let testResults = {
      createTask: false,
      taskList: false,
      filters: false,
      search: false,
      taskInteraction: false
    };
    
    // Test 1: Create Task Button
    try {
      const createButtons = pageAnalysis.allButtons.filter(btn => 
        btn.text.includes('T·∫°o') || btn.text.includes('Create') || btn.text.includes('Add')
      );
      
      if (createButtons.length > 0) {
        console.log(`‚úÖ T√¨m th·∫•y ${createButtons.length} n√∫t t·∫°o: ${createButtons.map(b => b.text).join(', ')}`);
        
        // Try to click create button
        const createButton = page.locator('button').filter({ hasText: /T·∫°o|Create|Add/ }).first();
        if (await createButton.count() > 0) {
          await createButton.click({ timeout: 5000 });
          await page.waitForTimeout(2000);
          
          // Check if modal opened
          const modalCheck = await page.evaluate(() => {
            return {
              hasModal: !!document.querySelector('.modal, .dialog, [role="dialog"]'),
              hasForm: !!document.querySelector('form'),
              hasOverlay: !!document.querySelector('.overlay, .backdrop')
            };
          });
          
          testResults.createTask = modalCheck.hasModal || modalCheck.hasForm;
          
          if (testResults.createTask) {
            console.log('‚úÖ Create task modal opened');
            await page.keyboard.press('Escape');
            await page.waitForTimeout(1000);
          }
        }
      }
    } catch (error) {
      console.log('‚ö†Ô∏è Create task test error:', error.message);
    }
    
    // Test 2: Task List
    testResults.taskList = pageAnalysis.hasTable || pageAnalysis.hasGrid || pageAnalysis.hasList || 
                          pageAnalysis.taskElements.length > 0;
    
    // Test 3: Filters
    testResults.filters = pageAnalysis.allSelects.length > 0 || 
                         pageAnalysis.allButtons.some(btn => 
                           btn.text.includes('L·ªçc') || btn.text.includes('Filter')
                         );
    
    // Test 4: Search
    testResults.search = pageAnalysis.allInputs.some(input => 
      input.placeholder?.toLowerCase().includes('t√¨m') || 
      input.placeholder?.toLowerCase().includes('search') ||
      input.type === 'search'
    );
    
    // Test 5: Task Interaction
    try {
      if (pageAnalysis.taskElements.length > 0) {
        // Try to click on a task element
        const taskElement = page.locator('*').filter({ hasText: /task|c√¥ng vi·ªác/i }).first();
        if (await taskElement.count() > 0) {
          await taskElement.click({ timeout: 3000 });
          await page.waitForTimeout(1000);
          
          const interactionCheck = await page.evaluate(() => {
            return {
              hasModal: !!document.querySelector('.modal, .dialog, [role="dialog"]'),
              urlChanged: window.location.href !== 'http://localhost:8088/tasks'
            };
          });
          
          testResults.taskInteraction = interactionCheck.hasModal || interactionCheck.urlChanged;
          
          if (testResults.taskInteraction) {
            console.log('‚úÖ Task interaction detected');
            await page.keyboard.press('Escape');
            await page.waitForTimeout(500);
          }
        }
      }
    } catch (error) {
      console.log('‚ö†Ô∏è Task interaction test error:', error.message);
    }
    
    // ==================== FINAL RESULTS ====================
    console.log('\n' + '='.repeat(80));
    console.log('üìä K·∫æT QU·∫¢ TEST MENU C√îNG VI·ªÜC');
    console.log('='.repeat(80));
    
    const results = [
      { name: 'Page Access', success: !pageAnalysis.loadingText },
      { name: 'Create Task', success: testResults.createTask },
      { name: 'Task List', success: testResults.taskList },
      { name: 'Filters', success: testResults.filters },
      { name: 'Search', success: testResults.search },
      { name: 'Task Interaction', success: testResults.taskInteraction }
    ];
    
    let successCount = 0;
    results.forEach((result, index) => {
      const status = result.success ? '‚úÖ HO·∫†T ƒê·ªòNG' : '‚ùå KH√îNG HO·∫†T ƒê·ªòNG';
      console.log(`${(index + 1).toString().padStart(2, '0')}. ${result.name.padEnd(20, ' ')}: ${status}`);
      if (result.success) successCount++;
    });
    
    console.log('\n' + '='.repeat(80));
    console.log(`üéØ T·ªîNG K·∫æT: ${successCount}/${results.length} t√≠nh nƒÉng ho·∫°t ƒë·ªông (${Math.round(successCount/results.length*100)}%)`);
    
    if (successCount >= 5) {
      console.log('üéâ XU·∫§T S·∫ÆC! Menu C√¥ng vi·ªác ho·∫°t ƒë·ªông r·∫•t t·ªët!');
    } else if (successCount >= 3) {
      console.log('üëç T·ªêT! C√°c t√≠nh nƒÉng ch√≠nh ho·∫°t ƒë·ªông!');
    } else {
      console.log('‚ö†Ô∏è C·∫¶N C·∫¢I THI·ªÜN! Nhi·ªÅu t√≠nh nƒÉng ch∆∞a ho·∫°t ƒë·ªông!');
    }
    
    // Show detailed page content for debugging
    console.log('\nüìã DETAILED PAGE CONTENT (for debugging):');
    console.log('Buttons found:', JSON.stringify(pageAnalysis.allButtons, null, 2));
    console.log('Body text preview:', pageAnalysis.bodyText);
    
    console.log('='.repeat(80));
    
    // ƒê·ª£i 20 gi√¢y ƒë·ªÉ quan s√°t
    console.log('\n‚è≥ ƒê·ª£i 20 gi√¢y ƒë·ªÉ quan s√°t k·∫øt qu·∫£...');
    await page.waitForTimeout(20000);
    
  } catch (error) {
    console.error('‚ùå CRITICAL ERROR:', error.message);
    console.error('Stack trace:', error.stack);
  } finally {
    await browser.close();
    console.log('\nüèÅ TEST HO√ÄN TH√ÄNH');
  }
})();
