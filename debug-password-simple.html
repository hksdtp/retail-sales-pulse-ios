<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Password Issue</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #2a2a2a; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        button { padding: 10px 15px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; }
        button:hover { background: #444; }
        input { padding: 8px; margin: 5px; background: #333; color: #fff; border: 1px solid #555; }
        pre { background: #1a1a1a; padding: 10px; border-left: 3px solid #00ff00; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Password Issue</h1>
    
    <div class="section">
        <h2>üì¶ LocalStorage Analysis</h2>
        <button onclick="analyzeLocalStorage()">Analyze LocalStorage</button>
        <pre id="localStorage-output"></pre>
    </div>
    
    <div class="section">
        <h2>üß™ Test Login</h2>
        <input type="email" id="test-email" placeholder="Email" value="">
        <input type="password" id="test-password" placeholder="Password">
        <button onclick="testLogin()">Test Login</button>
        <pre id="login-output"></pre>
    </div>
    
    <div class="section">
        <h2>üîß Emergency Fix</h2>
        <input type="text" id="fix-userId" placeholder="User ID">
        <input type="password" id="fix-password" placeholder="New Password">
        <button onclick="emergencyPasswordReset()">Reset Password</button>
        <button onclick="clearAllPasswords()" class="error">Clear All Passwords</button>
        <pre id="fix-output"></pre>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            element.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        }

        function analyzeLocalStorage() {
            const output = document.getElementById('localStorage-output');
            output.innerHTML = '';
            
            log('localStorage-output', 'Analyzing localStorage...');
            
            // Get all keys
            const allKeys = Object.keys(localStorage);
            const passwordKeys = allKeys.filter(key => key.startsWith('user_password_'));
            const userKeys = allKeys.filter(key => key.includes('User') || key.includes('user'));
            
            log('localStorage-output', `Total keys: ${allKeys.length}`);
            log('localStorage-output', `Password keys: ${passwordKeys.length}`);
            log('localStorage-output', `User-related keys: ${userKeys.length}`);
            
            // Show password keys
            if (passwordKeys.length > 0) {
                log('localStorage-output', '\nüîë Password Keys:');
                passwordKeys.forEach(key => {
                    const userId = key.replace('user_password_', '');
                    const password = localStorage.getItem(key);
                    log('localStorage-output', `   ${userId}: ${password ? '***' + password.length + ' chars' : 'null'}`);
                });
            } else {
                log('localStorage-output', '‚ö†Ô∏è No password keys found!', 'warning');
            }
            
            // Check currentUser
            const currentUserStr = localStorage.getItem('currentUser');
            if (currentUserStr) {
                try {
                    const currentUser = JSON.parse(currentUserStr);
                    log('localStorage-output', '\nüë§ Current User:');
                    log('localStorage-output', `   ID: ${currentUser.id}`);
                    log('localStorage-output', `   Name: ${currentUser.name}`);
                    log('localStorage-output', `   Email: ${currentUser.email}`);
                    log('localStorage-output', `   Password Changed: ${currentUser.password_changed}`);
                    
                    // Set email for testing
                    document.getElementById('test-email').value = currentUser.email;
                    document.getElementById('fix-userId').value = currentUser.id;
                    
                    // Check if user has stored password
                    const userPassword = localStorage.getItem(`user_password_${currentUser.id}`);
                    if (userPassword) {
                        log('localStorage-output', `   Stored Password: ***${userPassword.length} chars`, 'success');
                    } else {
                        log('localStorage-output', '   Stored Password: NOT SET', 'error');
                    }
                } catch (e) {
                    log('localStorage-output', `Error parsing currentUser: ${e.message}`, 'error');
                }
            } else {
                log('localStorage-output', '‚ö†Ô∏è No currentUser found!', 'warning');
            }
            
            // Check mockUsers
            const mockUsersStr = localStorage.getItem('mockUsers');
            if (mockUsersStr) {
                try {
                    const mockUsers = JSON.parse(mockUsersStr);
                    log('localStorage-output', `\nüé≠ MockUsers: ${mockUsers.length} users`);
                    mockUsers.forEach(user => {
                        log('localStorage-output', `   ${user.name} (${user.id}): password_changed = ${user.password_changed}`);
                    });
                } catch (e) {
                    log('localStorage-output', `Error parsing mockUsers: ${e.message}`, 'error');
                }
            }
        }

        async function testLogin() {
            const output = document.getElementById('login-output');
            output.innerHTML = '';
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log('login-output', 'Please enter both email and password', 'error');
                return;
            }
            
            log('login-output', `Testing login for: ${email}`);
            log('login-output', `Password length: ${password.length} chars`);
            
            // Simulate the mock login logic
            try {
                // Check admin password
                const ADMIN_PASSWORD = 'Haininh1';
                const DEFAULT_PASSWORD = '123456';
                
                if (password === ADMIN_PASSWORD) {
                    log('login-output', '‚úÖ Admin password detected - should work for any user', 'success');
                    return;
                }
                
                if (password === DEFAULT_PASSWORD) {
                    log('login-output', '‚ö†Ô∏è Default password detected', 'warning');
                }
                
                // Get current user
                const currentUserStr = localStorage.getItem('currentUser');
                if (currentUserStr) {
                    const currentUser = JSON.parse(currentUserStr);
                    if (currentUser.email.toLowerCase() === email.toLowerCase()) {
                        const storedPassword = localStorage.getItem(`user_password_${currentUser.id}`);
                        
                        if (storedPassword) {
                            if (password === storedPassword) {
                                log('login-output', '‚úÖ Custom password matches!', 'success');
                            } else {
                                log('login-output', '‚ùå Custom password does not match', 'error');
                                log('login-output', `Expected: ***${storedPassword.length} chars`, 'warning');
                                log('login-output', `Got: ***${password.length} chars`, 'warning');
                            }
                        } else if (password === DEFAULT_PASSWORD && !currentUser.password_changed) {
                            log('login-output', '‚úÖ First login with default password', 'success');
                        } else {
                            log('login-output', '‚ùå No stored password and not first login', 'error');
                        }
                    } else {
                        log('login-output', '‚ö†Ô∏è Email does not match current user', 'warning');
                    }
                }
                
            } catch (error) {
                log('login-output', `Error during test: ${error.message}`, 'error');
            }
        }

        function emergencyPasswordReset() {
            const output = document.getElementById('fix-output');
            output.innerHTML = '';
            
            const userId = document.getElementById('fix-userId').value;
            const newPassword = document.getElementById('fix-password').value;
            
            if (!userId || !newPassword) {
                log('fix-output', 'Please enter both User ID and new password', 'error');
                return;
            }
            
            log('fix-output', `Resetting password for user: ${userId}`);
            
            try {
                // Store new password
                localStorage.setItem(`user_password_${userId}`, newPassword);
                log('fix-output', '‚úÖ Stored new password in localStorage', 'success');
                
                // Update currentUser if it's the same user
                const currentUserStr = localStorage.getItem('currentUser');
                if (currentUserStr) {
                    const currentUser = JSON.parse(currentUserStr);
                    if (currentUser.id === userId) {
                        currentUser.password_changed = true;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        log('fix-output', '‚úÖ Updated currentUser password_changed flag', 'success');
                    }
                }
                
                // Update mockUsers
                const mockUsersStr = localStorage.getItem('mockUsers');
                if (mockUsersStr) {
                    const mockUsers = JSON.parse(mockUsersStr);
                    const userIndex = mockUsers.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        mockUsers[userIndex].password_changed = true;
                        localStorage.setItem('mockUsers', JSON.stringify(mockUsers));
                        log('fix-output', '‚úÖ Updated mockUsers password_changed flag', 'success');
                    }
                }
                
                log('fix-output', 'üéâ Password reset completed!', 'success');
                log('fix-output', 'Try logging out and logging in with the new password.', 'success');
                
            } catch (error) {
                log('fix-output', `Error during reset: ${error.message}`, 'error');
            }
        }

        function clearAllPasswords() {
            const output = document.getElementById('fix-output');
            output.innerHTML = '';
            
            if (!confirm('Are you sure you want to clear ALL password data? This will reset everyone to default passwords.')) {
                return;
            }
            
            log('fix-output', 'Clearing all password data...');
            
            const passwordKeys = Object.keys(localStorage).filter(key => key.startsWith('user_password_'));
            passwordKeys.forEach(key => {
                localStorage.removeItem(key);
                log('fix-output', `Removed: ${key}`);
            });
            
            log('fix-output', 'üí• All password data cleared!', 'warning');
            log('fix-output', 'All users will now use default password: 123456', 'warning');
        }

        // Auto-analyze on load
        window.onload = function() {
            analyzeLocalStorage();
        };
    </script>
</body>
</html>
